<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Platform Docker – Safe Date</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background: #000; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; }
    header { background: #222; padding: 1rem; }
    .platform-docker { background: #111; overflow-x: auto; position: relative; }
    .timeline-container { position: relative; width: 72000px; }
    .time-marker { position: absolute; top: 0; bottom: 0; width: 1px; background: #333; z-index: 0; }
    .time-marker.major { background: #888; width: 2px; }
    .time-label { position: absolute; top: 0; font-size: 0.75rem; color: #ccc; transform: translateX(-50%); z-index: 2; }
    .platform-row { display: flex; height: 80px; position: relative; border-top: 1px solid #333; }
    .platform-label { width: 100px; background: #222; color: white; text-align: center; line-height: 80px; position: sticky; left: 0; z-index: 3; }
    .platform-timeline { flex: 1; position: relative; }
    .train-event {
      position: absolute; top: 20px; height: 50px; font-size: 1.25rem; font-weight: bold;
      color: white; white-space: nowrap; border-radius: 5px; padding: 0 14px 0 40px;
      display: flex; align-items: center; overflow: visible; z-index: 2; background-color: #70b8ff;
    }
    .train-icons {
      position: absolute; left: 4px; top: 50%; transform: translateY(-50%);
      display: flex; flex-direction: column; gap: 2px; font-size: 1rem;
    }
    .arriving-train-label, .departing-train-label {
      position: absolute; font-size: 1.2rem; color: black;
      background-color: white; padding: 2px 8px; top: -18px;
    }
    .arriving-train-label { left: 0; }
    .departing-train-label { right: 0; }
  </style>
</head>
<body>
<header class="text-white">
  <div class="container">
    <h1 class="mb-3">Platform Docker</h1>
    <form class="row g-3" id="dockerForm">
      <div class="col-md-4">
        <label for="location" class="form-label">Location (TIPLOC)</label>
        <input type="text" class="form-control" id="location" value="CHRX" required>
      </div>
      <div class="col-md-4">
        <label for="date" class="form-label">Date</label>
        <input type="date" class="form-control" id="date" required>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Load Platform Docker</button>
      </div>
    </form>
  </div>
</header>
<div class="platform-docker">
  <div class="timeline-container" id="timelineContainer"></div>
</div>

<script>
function hhmmToMinutes(hhmm) {
  if (!hhmm || hhmm.length !== 4) return null;
  return parseInt(hhmm.slice(0, 2)) * 60 + parseInt(hhmm.slice(2));
}

document.addEventListener("DOMContentLoaded", () => {
  const dateInput = document.getElementById("date");
  dateInput.value = new Date().toISOString().split("T")[0];

  const form = document.getElementById("dockerForm");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const location = document.getElementById("location").value;
    const date = document.getElementById("date").value;

    try {
      const res = await fetch("/web/platform_docker_data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ location, date, page: 1, per_page: 10 })
      });

      const data = await res.json();
      renderTimeline(restructureEvents(data), 50);
    } catch (err) {
      console.error("Fetch error:", err);
      document.getElementById("timelineContainer").innerHTML =
        '<p class="text-danger p-3">Error loading data: ' + err.message + '</p>';
    }
  });
});

function restructureEvents(data) {
  return {
    platforms: (data.platforms||[]).map(platform => {
      const rawByUid = {};
      platform.events.forEach(ev => rawByUid[ev.uid] = ev);

      const seen = new Set();
      const merged = [];

      for (const ev of platform.events) {
        if (seen.has(ev.uid)) continue;

        // Split (divide)
        if (ev.arrival_time && !ev.departure_time && ev.forms_to_uids?.length > 1) {
          for (let i = 0; i < ev.forms_to_uids.length; i++) {
            const child = rawByUid[ev.forms_to_uids[i]];
            if (child && child.departure_time && !child.arrival_time) {
              merged.push({
                uid:            child.uid,
                headcode:       child.headcode,
                arrival_time:   ev.arrival_time,
                departure_time: child.departure_time,
                from:           ev.headcode,
                to:             child.headcode,
                late:           child.late || ev.late,
                conflict:       child.conflict || ev.conflict
              });
              seen.add(child.uid);
            }
          }
          seen.add(ev.uid);
          continue;
        }

        // Join
        if (ev.departure_time && !ev.arrival_time && ev.forms_from_uids?.length > 1) {
          const parents = ev.forms_from_uids.map(uid => rawByUid[uid]).filter(p => p && p.arrival_time && !p.departure_time);
          if (parents.length > 1) {
            const earliest = parents.map(p => p.arrival_time).sort()[0];
            merged.push({
              uid:            ev.uid,
              headcode:       ev.headcode,
              arrival_time:   earliest,
              departure_time: ev.departure_time,
              from:           parents.map(p => p.headcode).join(","),
              to:             ev.headcode,
              late:           ev.late || parents.some(p=>p.late),
              conflict:       ev.conflict || parents.some(p=>p.conflict)
            });
            parents.forEach(p=>seen.add(p.uid));
            seen.add(ev.uid);
            continue;
          }
        }

        // One-to-one continue
        if (ev.arrival_time && !ev.departure_time && ev.forms_to_uids?.length === 1) {
          const child = rawByUid[ev.forms_to_uids[0]];
          if (child && child.departure_time && !child.arrival_time) {
            merged.push({
              uid:            child.uid,
              headcode:       child.headcode,
                arrival_time:   ev.arrival_time,
                departure_time: child.departure_time,
                from:           ev.headcode,
                to:             child.headcode,
                late:           child.late || ev.late,
                conflict:       child.conflict || ev.conflict
              });
            seen.add(ev.uid);
            seen.add(child.uid);
            continue;
          }
        }

        // Fallback
        merged.push({
          uid:            ev.uid,
          headcode:       ev.headcode,
          arrival_time:   ev.arrival_time || null,
          departure_time: ev.departure_time || null,
          from:           ev.forms_from_headcodes?.[0] || null,
          to:             ev.forms_to_headcodes?.[0]   || null,
          late:           ev.late,
          conflict:       ev.conflict
        });
        seen.add(ev.uid);
      }

      return { name: platform.name, events: merged };
    })
  };
}

function renderTimeline(data, scale = 50) {
  const container = document.getElementById("timelineContainer");
  container.innerHTML = '';
  for (let i = 0; i < 1440; i++) {
    const marker = document.createElement("div");
    marker.className = "time-marker" + (i % 5 === 0 ? " major" : "");
    marker.style.left = (i * scale) + "px";
    container.appendChild(marker);
    if (i % 5 === 0) {
      const label = document.createElement("div");
      label.className = "time-label";
      label.style.left = (i * scale) + "px";
      label.textContent = String(Math.floor(i / 60)).padStart(2, '0') + ":" + String(i % 60).padStart(2, '0');
      container.appendChild(label);
    }
  }

  (data.platforms || []).forEach(platform => {
    const row = document.createElement("div");
    row.className = "platform-row";
    const label = document.createElement("div");
    label.className = "platform-label";
    label.textContent = "Platform " + platform.name;
    row.appendChild(label);

    const timeline = document.createElement("div");
    timeline.className = "platform-timeline";
    timeline.style.width = (1440 * scale) + "px";

    (platform.events || []).forEach(ev => {
      const arr = hhmmToMinutes(ev.arrival_time);
      const dep = hhmmToMinutes(ev.departure_time);
      const left = (arr ?? dep ?? 0) * scale;
      const width = (dep && arr) ? (dep - arr) * scale : 30;

      const box = document.createElement("div");
      box.className = "train-event";
      box.style.left = left + "px";
      box.style.width = Math.max(width, 30) + "px";

      // Icon placeholder
      const icons = document.createElement("div");
      icons.className = "train-icons";
      if (ev.late) {
        const ic = document.createElement("span");
        ic.textContent = "⏰";
        icons.appendChild(ic);
      }
      if (ev.conflict) {
        const ic = document.createElement("span");
        ic.textContent = "⚠️";
        icons.appendChild(ic);
      }
      // split
      if (ev.from && ev.to && ev.forms_to_uids?.length > 1) {
        const ic = document.createElement("span");
        ic.textContent = "✂️";
        icons.appendChild(ic);
      }
      // join
      if (ev.from && ev.to && ev.forms_from_uids?.length > 1) {
        const ic = document.createElement("span");
        ic.textContent = "🔗";
        icons.appendChild(ic);
      }
      box.appendChild(icons);

      // Native tooltip
      const tooltipLines = [`Train ${ev.headcode}`];
      if (ev.from)           tooltipLines.push(`From: ${ev.from}`);
      if (ev.to)             tooltipLines.push(`To:   ${ev.to}`);
      if (ev.arrival_time)   tooltipLines.push(`Arr:  ${ev.arrival_time}`);
      if (ev.departure_time) tooltipLines.push(`Dep:  ${ev.departure_time}`);
      box.setAttribute("title", tooltipLines.join("\n"));

      if (!ev.from && !ev.to) {
        box.textContent = ev.headcode;
      }

      if (ev.from) {
        const from = document.createElement("div");
        from.className = "arriving-train-label";
        from.textContent = ev.from;
        box.appendChild(from);
      }

      if (ev.to) {
        const to = document.createElement("div");
        to.className = "departing-train-label";
        to.textContent = ev.to;
        box.appendChild(to);
      }

      timeline.appendChild(box);
    });

    row.appendChild(timeline);
    container.appendChild(row);
  });
}
</script>
</body>
</html>
