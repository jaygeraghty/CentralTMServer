{% extends "base.html" %}

{% block title %}Database Maintenance{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h1>Database Maintenance</h1>
            <div class="alert alert-warning">
                <h4 class="alert-heading">Warning!</h4>
                <p>This page allows you to reset and reload the database with CIF files from the import folder.</p>
                <p><strong>This operation will delete all existing data and replace it with data from the CIF files in the import folder.</strong></p>
            </div>

            <!-- Flash messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="card mt-4">
                <div class="card-header">
                    <h5>Reset Database and Load CIF Files</h5>
                </div>
                <div class="card-body">
                    <p>This operation will:</p>
                    <ol>
                        <li>Delete all existing schedule data from the database</li>
                        <li>Process all CIF files located in the import folder</li>
                        <li>Load the processed data into the database</li>
                    </ol>
                    <p>Make sure you have placed the CIF files you want to load in the import folder before proceeding.</p>
                    
                    <div class="mt-3">
                        <form method="post" action="{{ url_for('web.reset_reload_db') }}" onsubmit="return confirm('Are you sure? This will delete all existing data.');">
                            <input type="hidden" name="action" value="reset_and_reload">
                            <button type="submit" class="btn btn-danger">Reset Database and Load CIF Files</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5>Database Status</h5>
                </div>
                <div class="card-body">
                    <div id="status-basic">
                        <p><strong>Database contains:</strong></p>
                        <ul>
                            <li>Permanent schedules (P): <span id="ltp-count">Loading...</span></li>
                            <li>New schedules (N): <span id="new-count">Loading...</span></li>
                            <li>Overlay schedules (O): <span id="overlay-count">Loading...</span></li>
                            <li>Cancellation schedules (C): <span id="cancel-count">Loading...</span></li>
                        </ul>
                        <button id="show-details" class="btn btn-info">Show Association Details</button>
                    </div>
                    
                    <div id="status-details" class="mt-4" style="display: none;">
                        <h6><strong>Associations:</strong></h6>
                        <ul>
                            <li>Permanent associations (P): <span id="ltp-assoc-count">Loading...</span></li>
                            <li>New associations (N): <span id="new-assoc-count">Loading...</span></li>
                            <li>Overlay associations (O): <span id="overlay-assoc-count">Loading...</span></li>
                            <li>Cancellation associations (C): <span id="cancel-assoc-count">Loading...</span></li>
                        </ul>
                        
                        <h6><strong>Locations:</strong></h6>
                        <ul>
                            <li>Permanent locations (P): <span id="ltp-loc-count">Loading...</span></li>
                            <li>New locations (N): <span id="new-loc-count">Loading...</span></li>
                            <li>Overlay locations (O): <span id="overlay-loc-count">Loading...</span></li>
                            <li>Cancellation locations (C): <span id="cancel-loc-count">Loading...</span></li>
                        </ul>
                        
                        <button id="hide-details" class="btn btn-secondary">Hide Details</button>
                    </div>
                    
                    <div class="mt-3">
                        <button id="refresh-status" class="btn btn-primary">Refresh Status</button>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <a href="{{ url_for('web.index') }}" class="btn btn-primary">Back to Home</a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initial load of status
        fetchDatabaseStatus();
        
        // Set up refresh button
        document.getElementById('refresh-status').addEventListener('click', fetchDatabaseStatus);
        
        // Set up show/hide details buttons
        document.getElementById('show-details').addEventListener('click', function() {
            document.getElementById('status-details').style.display = 'block';
            document.getElementById('show-details').style.display = 'none';
        });
        
        document.getElementById('hide-details').addEventListener('click', function() {
            document.getElementById('status-details').style.display = 'none';
            document.getElementById('show-details').style.display = 'inline-block';
        });
    });
    
    function fetchDatabaseStatus() {
        fetch('/api/db_status')
            .then(response => response.json())
            .then(data => {
                // Check if we received an error
                if (data.error) {
                    alert('Error fetching database status: ' + data.error);
                    return;
                }
                
                // Update schedule counts
                document.getElementById('ltp-count').textContent = data.schedules.ltp || 0;
                document.getElementById('new-count').textContent = data.schedules.stp_new || 0;
                document.getElementById('overlay-count').textContent = data.schedules.stp_overlay || 0;
                document.getElementById('cancel-count').textContent = data.schedules.stp_cancellation || 0;
                
                // Update association counts if available
                if (data.associations) {
                    document.getElementById('ltp-assoc-count').textContent = data.associations.ltp || 0;
                    document.getElementById('new-assoc-count').textContent = data.associations.stp_new || 0;
                    document.getElementById('overlay-assoc-count').textContent = data.associations.stp_overlay || 0;
                    document.getElementById('cancel-assoc-count').textContent = data.associations.stp_cancellation || 0;
                }
                
                // Update location counts if available
                if (data.locations) {
                    document.getElementById('ltp-loc-count').textContent = data.locations.ltp || 0;
                    document.getElementById('new-loc-count').textContent = data.locations.stp_new || 0;
                    document.getElementById('overlay-loc-count').textContent = data.locations.stp_overlay || 0;
                    document.getElementById('cancel-loc-count').textContent = data.locations.stp_cancellation || 0;
                }
            })
            .catch(error => {
                alert('Error fetching database status: ' + error.message);
            });
    }
</script>
{% endblock %}